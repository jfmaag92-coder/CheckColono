<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CheckColono</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, sans-serif;
      line-height: 1.4;
    }
    body {
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
      display: flex;
      justify-content: center;
    }
    .app-container {
      max-width: 480px;
      width: 100%;
      padding: 16px;
    }
    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      padding: 20px;
      margin-bottom: 16px;
    }
    h1 {
      font-size: 1.6rem;
      margin: 0 0 4px 0;
    }
    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
      font-weight: 600;
    }
    input, select, button {
      width: 100%;
      box-sizing: border-box;
      padding: 10px 12px;
      border-radius: 10px;
      border: 1px solid #ccc;
      font-size: 0.95rem;
      margin-bottom: 12px;
    }
    button {
      border: none;
      cursor: pointer;
      background: #007aff;
      color: #fff;
      font-weight: 600;
    }
    #exportBtn {
      background: #e5f0ff;
      color: #0050aa;
      margin-top: 10px;
    }
    #exportBtn:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    .warning {
      font-size: 0.85rem;
      color: #b00020;
      margin-top: 4px;
    }
    .timeline-item {
      margin-bottom: 12px;
      padding-left: 16px;
      position: relative;
    }
    .timeline-item::before {
      content:"";
      position: absolute;
      left: 0;
      top: 5px;
      width: 8px;
      height: 8px;
      background:#007aff;
      border-radius:50%;
    }
    .timeline-item time {
      font-size: 0.9rem;
      color: #555;
      display:block;
    }
    .timeline-item p {
      margin: 2px 0 0 0;
      font-size: 0.95rem;
    }
    .banner-warning {
      background:#fff3cd;
      border:1px solid #ffeeba;
      font-size:0.9rem;
    }
    .small-note {
      font-size: 0.85rem;
      color:#555;
      margin-top:4px;
    }
    a.safari-link {
      color:#007aff;
      text-decoration:underline;
      word-break:break-all;
    }
  </style>
</head>

<body>
  <div class="app-container">

    <!-- Banner para Chrome en iPhone -->
    <div id="browserWarning" class="card banner-warning" style="display:none;">
      <strong>Si estás usando iPhone con Chrome:</strong>
      <p class="small-note">
        Para que el plan se agregue bien al calendario:
      </p>
      <ol class="small-note">
        <li>Mantené presionado el siguiente enlace.</li>
        <li>Elegí <b>"Abrir en Safari"</b>.</li>
        <li>En Safari volvé a generar el plan y tocá “Exportar plan a calendario”.</li>
      </ol>
      <p class="small-note">
        Enlace para abrir en Safari (mantené presionado):
      </p>
      <a class="safari-link" href="https://jfmaag92-coder.github.io/CheckColono/">
        https://jfmaag92-coder.github.io/CheckColono/
      </a>
    </div>

    <!-- Tarjeta de ingreso -->
    <div class="card">
      <h1>CheckColono</h1>

      <label>Fecha y hora del estudio</label>
      <input id="datetime" type="datetime-local">

      <label>Tipo de preparación</label>
      <select id="prepType">
        <option value="peg_split">PEG en dosis divididas (ejemplo)</option>
      </select>

      <button id="generateBtn">Generar plan</button>
      <div id="warning" class="warning"></div>
    </div>

    <!-- Tarjeta del plan -->
    <div class="card">
      <h2>Tu plan de preparación</h2>
      <div id="timelineContainer">
        <p>Ingresá los datos y generá el plan.</p>
      </div>

      <button id="exportBtn" disabled>Exportar plan a calendario (.ics)</button>
      <p class="small-note">
        Luego abrí el archivo en el calendario de tu teléfono para recibir recordatorios.
      </p>
    </div>

  </div>

<script>
// detectar iPhone + Chrome
const ua = navigator.userAgent || navigator.vendor || window.opera || "";
const isIOS = /iPad|iPhone|iPod/.test(ua);
const isChromeIOS = isIOS && /CriOS/.test(ua); // "CriOS" = Chrome en iOS
const browserWarning = document.getElementById("browserWarning");
if (isChromeIOS && browserWarning) {
  browserWarning.style.display = "block";
}

// referencias DOM
const btn = document.getElementById("generateBtn");
const datetimeInput = document.getElementById("datetime");
const prepTypeSelect = document.getElementById("prepType");
const warningEl = document.getElementById("warning");
const timelineContainer = document.getElementById("timelineContainer");
const exportBtn = document.getElementById("exportBtn");
let lastEvents = [];

// utilidades
function addDays(d, n){ const x=new Date(d); x.setDate(x.getDate()+n); return x; }
function addHours(d, n){ const x=new Date(d); x.setHours(x.getHours()+n); return x; }
function formatDateTime(date){
  return date.toLocaleString("es-AR",{
    weekday:"short", day:"2-digit", month:"2-digit",
    hour:"2-digit", minute:"2-digit"
  });
}

// plan PEG split (ejemplo)
function generatePegSplitPlan(colonoDate){
  const ev=[];
  const dayMinus3=addDays(colonoDate,-3);
  const dayMinus1=addDays(colonoDate,-1);
  const hour=colonoDate.getHours();
  const isMorning=hour<12;

  ev.push({time:new Date(dayMinus3.getFullYear(),dayMinus3.getMonth(),dayMinus3.getDate(),9,0),
           text:"Iniciar dieta baja en residuos."});

  ev.push({time:new Date(dayMinus1.getFullYear(),dayMinus1.getMonth(),dayMinus1.getDate(),9,0),
           text:"Dieta de líquidos claros."});

  let dose1 = new Date(dayMinus1);
  dose1.setHours(isMorning?18:20, 0);
  ev.push({time:dose1, text:"Primera dosis de solución de PEG."});

  ev.push({time:addHours(colonoDate,-5), text:"Segunda dosis de solución de PEG."});
  ev.push({time:addHours(colonoDate,-6), text:"Iniciar ayuno de sólidos."});
  ev.push({time:addHours(colonoDate,-1.5), text:"Presentarse en el centro médico."});

  ev.sort((a,b)=>a.time-b.time);
  return ev;
}

// renderizar plan
function renderTimeline(events){
  if(!events.length){
    timelineContainer.innerHTML="<p>No hay eventos.</p>";
    return;
  }
  let html="";
  for(const e of events){
    html+=`<div class="timeline-item">
             <time>${formatDateTime(e.time)}</time>
             <p>${e.text}</p>
           </div>`;
  }
  timelineContainer.innerHTML=html;
}

// ICS helpers
function toICSDate(date){
  const y=date.getFullYear();
  const m=String(date.getMonth()+1).padStart(2,"0");
  const d=String(date.getDate()).padStart(2,"0");
  const h=String(date.getHours()).padStart(2,"0");
  const min=String(date.getMinutes()).padStart(2,"0");
  return `${y}${m}${d}T${h}${min}00`;
}

function generateICS(events){
  let ics="BEGIN:VCALENDAR\r\nVERSION:2.0\r\nPRODID:-//CheckColono//ES\r\n";
  const now=new Date();
  const dtstamp=toICSDate(now);

  events.forEach((ev,i)=>{
    const st=toICSDate(ev.time);
    const en=toICSDate(new Date(ev.time.getTime()+30*60000));
    const uid=`checkcolono-${dtstamp}-${i}`;
    const summary=ev.text.split(".")[0];

    ics+=`BEGIN:VEVENT\r\nUID:${uid}\r\nDTSTAMP:${dtstamp}\r\nDTSTART:${st}\r\nDTEND:${en}\r\nSUMMARY:${summary}\r\nDESCRIPTION:${ev.text}\r\nBEGIN:VALARM\r\nTRIGGER:-PT60M\r\nACTION:DISPLAY\r\nDESCRIPTION:Recordatorio CheckColono\r\nEND:VALARM\r\nEND:VEVENT\r\n`;
  });

  return ics+"END:VCALENDAR\r\n";
}

function downloadICS(events){
  const file=generateICS(events);
  const blob=new Blob([file],{type:"text/calendar"});
  const url=URL.createObjectURL(blob);
  const a=document.createElement("a");
  a.href=url;
  a.download="checkcolono-plan.ics";
  a.click();
  URL.revokeObjectURL(url);
}

// botón generar
btn.addEventListener("click",()=>{
  warningEl.textContent="";
  const val=datetimeInput.value;
  if(!val){
    warningEl.textContent="Ingresá fecha y hora.";
    return;
  }

  const date=new Date(val);
  let events=[];
  if (prepTypeSelect.value === "peg_split") {
    events=generatePegSplitPlan(date);
  }
  lastEvents=events;
  renderTimeline(events);
  exportBtn.disabled=events.length===0;
});

// botón exportar ICS
exportBtn.addEventListener("click",()=>{
  if(!lastEvents.length){
    alert("Primero generá un plan.");
    return;
  }
  downloadICS(lastEvents);
});
</script>

</body>
</html>
