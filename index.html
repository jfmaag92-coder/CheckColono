<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>CheckColono</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "SF Pro Text", sans-serif;
      line-height: 1.4;
    }

    body {
      margin: 0;
      padding: 0;
      background: #f5f5f7;
      color: #222;
      display: flex;
      flex-direction: column;
      align-items: center;
    }

    .app-container {
      max-width: 480px;
      width: 100%;
      padding: 16px;
      box-sizing: border-box;
    }

    .ios-chrome-banner {
      display: none;
      background: #fff3cd;
      color: #8a6d3b;
      border: 1px solid #ffeeba;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.85rem;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .timeband-banner {
      display: none;
      background: #e6f0ff;
      color: #1f3b75;
      border: 1px solid #cfe0ff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.85rem;
      margin-bottom: 12px;
      line-height: 1.4;
    }

    .general-note {
      display: none;
      background: #f1f5ff;
      color: #1f3b75;
      border: 1px solid #d6e2ff;
      border-radius: 12px;
      padding: 10px 12px;
      font-size: 0.85rem;
      margin: 10px 0 12px 0;
      line-height: 1.4;
    }

    .app-header {
      background: linear-gradient(135deg, #0052cc, #0b6eff);
      color: #ffffff;
      padding: 18px 16px 20px;
      border-radius: 0 0 24px 24px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.18);
      width: 100%;
      box-sizing: border-box;
      margin-bottom: 16px;
    }

    .app-header-inner {
      max-width: 480px;
      margin: 0 auto;
    }

    .app-header-title {
      font-size: 1.5rem;
      font-weight: 700;
      margin: 0 0 6px 0;
    }

    .app-header-tagline {
      font-size: 0.90rem;
      opacity: 0.92;
      margin: 0 0 3px 0;
    }

    .app-header-subtitle {
      font-size: 0.96rem;
      margin: 0;
      opacity: 0.96;
    }

    .card {
      background: #ffffff;
      border-radius: 16px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.06);
      padding: 20px;
      margin-bottom: 16px;
    }

    h1, h2 {
      margin: 0 0 12px 0;
      font-weight: 600;
    }

    .form-group { margin-bottom: 12px; }

    label {
      display: block;
      font-size: 0.9rem;
      margin-bottom: 4px;
      color: #555;
    }

    .control {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid #d0d5e0;
      font-size: 0.95rem;
      box-sizing: border-box;
      -webkit-appearance: none;
      appearance: none;
      background-color: #fff;
    }

    input.control {
      min-height: 44px;
      height: 44px;
      padding-top: 8px;
      padding-bottom: 8px;
    }

    input.control::-webkit-date-and-time-value {
      min-height: 44px;
      line-height: 44px;
    }

    select.control {
      background-image:
        linear-gradient(45deg, transparent 50%, #666 50%),
        linear-gradient(135deg, #666 50%, transparent 50%),
        linear-gradient(to right, transparent, transparent);
      background-position:
        calc(100% - 18px) calc(50% - 3px),
        calc(100% - 12px) calc(50% - 3px),
        calc(100% - 2.2rem) 0.5rem;
      background-size:
        6px 6px,
        6px 6px,
        1px 1.8rem;
      background-repeat: no-repeat;
      padding-right: 2.4rem;
      min-height: 44px;
      height: 44px;
    }

    .primary-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border-radius: 999px;
      border: none;
      background: #007aff;
      color: #ffffff;
      font-weight: 600;
      font-size: 1rem;
      cursor: pointer;
      margin-top: 8px;
    }

    .primary-btn:active { transform: scale(0.98); }

    .prep-steps {
      margin-top: 8px;
      position: relative;
    }

    .prep-steps::before {
      content: "";
      position: absolute;
      left: 10px;
      top: 4px;
      bottom: 4px;
      width: 2px;
      background: #e1e5f0;
    }

    .prep-step {
      margin-bottom: 16px;
      padding-left: 28px;
      position: relative;
    }

    .prep-step::before {
      content: "";
      position: absolute;
      left: 5px;
      top: 4px;
      width: 10px;
      height: 10px;
      border-radius: 999px;
      background: #0b6eff;
      box-shadow: 0 0 0 3px rgba(11,110,255,0.2);
    }

    .prep-time {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 2px;
    }

    .prep-desc {
      font-size: 1rem;
      color: #222;
      line-height: 1.35;
    }

    .prep-desc a,
    .inline-link {
      display: inline;
      color: #0066cc;
      text-decoration: underline;
      text-underline-offset: 2px;
      font-weight: 500;
    }

    .inline-link:hover { opacity: 0.8; }

    .plan-footer { margin-top: 20px; }

    .export-btn {
      display: block;
      width: 100%;
      padding: 12px 16px;
      border-radius: 12px;
      border: none;
      background: #e6f0ff;
      color: #0052cc;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
    }

    .export-btn:active { transform: scale(0.98); }
  </style>
</head>

<body>
  <div class="app-header">
    <div class="app-header-inner">
      <p class="app-header-title">CheckColono</p>
      <p class="app-header-tagline">Tu aliado en la preparación para tu endoscopía.</p>
      <p class="app-header-subtitle">Dra. Evelin Crocci</p>
    </div>
  </div>

  <div class="app-container">
    <div id="ios-chrome-banner" class="ios-chrome-banner">
      Para que tu calendario se guarde correctamente, abrí CheckColono en Safari.
      Desde Chrome, tocá el botón de compartir y elegí <strong>"Abrir en Safari"</strong>.
    </div>

    <div id="timeband-banner" class="timeband-banner"></div>

    <div class="card">
      <div class="form-group">
        <label for="regimen">Esquema de preparación</label>
        <select id="regimen" class="control">
          <option value="" selected disabled>Seleccioná tu esquema de preparación</option>
          <option value="novoprep">Novoprep</option>
          <option value="barex">Barex</option>
          <option value="barexkit">Barex Kit</option>
          <option value="barexplus">Barex Plus</option>
          <option value="sulfodom">Sulfodom</option>
        </select>
      </div>

      <div class="form-group">
        <label for="procedimiento">Fecha y hora del estudio</label>
        <input type="datetime-local" id="procedimiento" class="control">
      </div>

      <div class="form-group">
        <label for="constipado">¿Sos constipado/a?</label>
        <select id="constipado" class="control">
          <option value="" selected disabled>Seleccioná una opción</option>
          <option value="no">No</option>
          <option value="si">Sí</option>
        </select>
      </div>

      <button class="primary-btn" id="btn-generar">Generar plan</button>
    </div>

    <div class="card" id="plan-card" style="display:none;">
      <h2>Tu plan de preparación</h2>

      <div id="general-note" class="general-note">
        Si presentás náuseas o vómitos durante la preparación, interrumpí 30 minutos y retomá según lo indicado.
      </div>

      <div id="prep-steps" class="prep-steps"></div>

      <div class="plan-footer">
        <button class="export-btn" id="export-ics">Exportar plan a calendario (.ics)</button>
      </div>
    </div>
  </div>

<script>
  let currentPlan = [];

  function pad2(n) { return String(n).padStart(2, "0"); }

  function parseHHMM(hhmm) {
    const [h, m] = hhmm.split(":").map(Number);
    return (h * 60) + m;
  }

  function setDateWithTime(baseDate, dayOffset, hhmm) {
    const d = new Date(baseDate.getTime());
    d.setDate(d.getDate() + dayOffset);
    const [h, m] = hhmm.split(":").map(Number);
    d.setHours(h, m, 0, 0);
    return d;
  }

  function formatDateTime(date) {
    const dias = ["dom", "lun", "mar", "mié", "jue", "vie", "sáb"];
    const dia = dias[date.getDay()];
    const dd = String(date.getDate()).padStart(2, "0");
    const mm = String(date.getMonth() + 1).padStart(2, "0");

    let hours = date.getHours();
    const minutes = String(date.getMinutes()).padStart(2, "0");
    const isPM = hours >= 12;
    let label = isPM ? "p. m." : "a. m.";
    hours = hours % 12;
    if (hours === 0) hours = 12;

    return `${dia} ${dd}-${mm}, ${hours}:${minutes} ${label}`;
  }

  function pickTimeBand(protocol, procedureDate) {
    const t = procedureDate.getHours() * 60 + procedureDate.getMinutes();
    let best = null;

    protocol.timeBands.forEach(b => {
      const from = parseHHMM(b.from);
      const to = parseHHMM(b.to);

      const inside = (t >= from && t <= to);
      const dist = inside ? 0 : Math.min(Math.abs(t - from), Math.abs(t - to));

      if (!best || dist < best.dist) best = { band: b, dist, inside };
    });

    return { band: best.band, approximated: !best.inside };
  }

  function showTimebandBannerIfNeeded(approximated, selectedBandLabel) {
    const el = document.getElementById("timeband-banner");
    if (!el) return;

    if (!approximated) {
      el.style.display = "none";
      el.textContent = "";
      return;
    }

    el.innerHTML =
      `El horario ingresado no coincide exactamente con una franja estándar. ` +
      `Usamos la franja <strong>${selectedBandLabel}</strong> por ser la más cercana. ` +
      `Te sugerimos corroborar el horario informado para tu estudio.`;
    el.style.display = "block";
  }

  // NUEVO TEXTO + 9:00 todos los días (-3, -2, -1)
  function buildConstipationSteps(procedureDate) {
    const text = "Tomar 1 sobre de Barex (4,5 g de Polietilenglicol 3350) en un vaso de agua fría";
    return [
      { datetime: setDateWithTime(procedureDate, -3, "09:05"), text },
      { datetime: setDateWithTime(procedureDate, -2, "09:05"), text },
      { datetime: setDateWithTime(procedureDate, -1, "09:05"), text }
    ];
  }

  // pasos comunes (sin recordatorio de hierro)
  function buildCommonSteps(procedureDate, isConstipated) {
    const steps = [
      {
        datetime: setDateWithTime(procedureDate, -3, "09:00"),
        textBefore: "Iniciar ",
        linkText: "dieta baja en residuos",
        linkHref: "#",
        textAfter: " (3 días previos)."
      }
    ];

    if (isConstipated) {
      // Mantengo el mismo horario 09:00: quedarán dos eventos ese día (dieta + Barex),
      // tal como pediste “todos los días a las 9 hs”.
      steps.push(...buildConstipationSteps(procedureDate));
    }

    return steps;
  }

  const protocols = {
    novoprep: {
      label: "Novoprep",
      timeBands: [
        { label: "08:00–09:30", from: "08:00", to: "09:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo (última comida sólida antes del examen)." },
          { dayOffset: -1, time: "19:00", text: "Cena: caldos colados desgrasados + gelatina/helado de agua (no rojo)." },
          { dayOffset: -1, time: "20:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (según preparación indicada) y luego líquidos claros." },
          { dayOffset:  0, time: "04:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (segunda toma)." },
          { dayOffset:  0, time: "06:00", text: "Ayuno total de sólidos y líquidos (incluida el agua) desde esta hora." }
        ]},
        { label: "09:31–11:30", from: "09:31", to: "11:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo (última comida sólida antes del examen)." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados + gelatina/helado de agua (no rojo)." },
          { dayOffset: -1, time: "22:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (según preparación indicada) y luego líquidos claros." },
          { dayOffset:  0, time: "06:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (segunda toma)." },
          { dayOffset:  0, time: "08:00", text: "Ayuno total de sólidos y líquidos (incluida el agua) desde esta hora." }
        ]},
        { label: "11:31–15:30", from: "11:31", to: "15:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo (última comida sólida antes del examen)." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados + gelatina/helado de agua (no rojo)." },
          { dayOffset: -1, time: "23:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (según preparación indicada) y luego líquidos claros." },
          { dayOffset:  0, time: "07:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (segunda toma)." },
          { dayOffset:  0, time: "10:00", text: "Ayuno total de sólidos y líquidos (incluida el agua) desde esta hora." }
        ]},
        { label: "15:31–19:30", from: "15:31", to: "19:30", steps: [
          { dayOffset: -1, time: "21:00", text: "Cena (última comida sólida antes del examen)." },
          { dayOffset:  0, time: "07:00", text: "Desayuno: té o café con azúcar o edulcorante, a gusto." },
          { dayOffset:  0, time: "08:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (primera toma) y luego líquidos claros." },
          { dayOffset:  0, time: "11:00", text: "Tomar 1 comprimido de Bigetric + 1 sobre de Novoprep (segunda toma)." },
          { dayOffset:  0, time: "13:00", text: "Ayuno total de sólidos y líquidos (incluida el agua) desde esta hora." }
        ]}
      ]
    },

    barex: {
      label: "Barex",
      timeBands: [
        { label: "08:00–09:30", from: "08:00", to: "09:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; se recomiendan ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "19:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "19:10", text: "Preparación de la solución: agregar al envase agua potable hasta la marca de 4 litros. Tapar y agitar/meclar al menos 2 minutos hasta disolver. Sin agregar ingredientes. Mantener en heladera. Usar dentro de 48 horas." },
          { dayOffset: -1, time: "20:00", text: "Tomar 1 comprimido de Bigetric y comenzar la toma de Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "04:00", text: "Tomar 1 comprimido de Bigetric y recomenzar Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "06:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "09:31–11:30", from: "09:31", to: "11:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "20:10", text: "Preparación de la solución: agregar al envase agua potable hasta la marca de 4 litros. Tapar y agitar/meclar al menos 2 minutos hasta disolver. Sin agregar ingredientes. Mantener en heladera. Usar dentro de 48 horas." },
          { dayOffset: -1, time: "22:00", text: "Tomar 1 comprimido de Bigetric y comenzar la toma de Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "06:00", text: "Tomar 1 comprimido de Bigetric y recomenzar Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "08:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "11:31–15:30", from: "11:31", to: "15:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "20:10", text: "Preparación de la solución: agregar al envase agua potable hasta la marca de 4 litros. Tapar y agitar/meclar al menos 2 minutos hasta disolver. Sin agregar ingredientes. Mantener en heladera. Usar dentro de 48 horas." },
          { dayOffset: -1, time: "23:00", text: "Tomar 1 comprimido de Bigetric y comenzar la toma de Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "07:00", text: "Tomar 1 comprimido de Bigetric y recomenzar Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "09:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "15:31–20:00", from: "15:31", to: "20:00", steps: [
          { dayOffset: -1, time: "21:00", text: "Cena: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset:  0, time: "07:00", text: "Desayuno: té o café con azúcar o edulcorante, a gusto." },
          { dayOffset:  0, time: "07:10", text: "Preparación de la solución: agregar al envase agua potable hasta la marca de 4 litros. Tapar y agitar/meclar al menos 2 minutos hasta disolver. Sin agregar ingredientes. Mantener en heladera. Usar dentro de 48 horas." },
          { dayOffset:  0, time: "08:00", text: "Tomar 1 comprimido de Bigetric y comenzar Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "11:00", text: "Tomar 1 comprimido de Bigetric y recomenzar Barex: 1 vaso (250 cc) cada 15 minutos hasta completar 2 litros (en 2 horas). Es mejor ingerir el vaso completo rápidamente." },
          { dayOffset:  0, time: "13:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]}
      ]
    },

    barexkit: {
      label: "Barex Kit",
      timeBands: [
        { label: "08:00–09:30", from: "08:00", to: "09:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "18:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "19:00", text: "Tomar 4 comprimidos de Bisacodilo (incluidos en el Barex Kit) con un vaso de agua, sin masticarlos. Luego líquidos muy claros NO gasificados en abundancia. No mate, no café. (Gatorade: únicamente manzana)." },
          { dayOffset: -1, time: "19:10", text: "Preparar Barex: disolver 1 envase en 1 litro (recipiente 1 L). Preparar el segundo envase de la misma manera." },
          { dayOffset: -1, time: "21:00", text: "Tomar 1 comprimido de Bigetric y comenzar el primer litro de Barex: un vaso grande (~250 cm³) cada 15 minutos hasta completar 1 litro." },
          { dayOffset:  0, time: "04:00", text: "Tomar 1 comprimido de Bigetric y tomar el segundo litro de Barex: un vaso grande cada 15 minutos hasta completarlo." },
          { dayOffset:  0, time: "06:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "09:31–11:30", from: "09:31", to: "11:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "19:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "20:00", text: "Tomar 4 comprimidos de Bisacodilo (incluidos en el Barex Kit) con un vaso de agua, sin masticarlos. Luego líquidos muy claros NO gasificados. No mate, no café. (Gatorade: únicamente manzana)." },
          { dayOffset: -1, time: "20:10", text: "Preparar Barex: disolver 1 envase en 1 litro. Preparar el segundo envase de la misma manera." },
          { dayOffset: -1, time: "22:00", text: "Tomar 1 comprimido de Bigetric y comenzar el primer litro de Barex: un vaso grande (~250 cm³) cada 15 minutos hasta completar 1 litro." },
          { dayOffset:  0, time: "06:00", text: "Tomar 1 comprimido de Bigetric y tomar el segundo litro de Barex: un vaso grande cada 15 minutos hasta completarlo." },
          { dayOffset:  0, time: "08:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "11:31–15:30", from: "11:31", to: "15:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "21:00", text: "Tomar 4 comprimidos de Bisacodilo (incluidos en el Barex Kit) con un vaso de agua, sin masticarlos. Luego líquidos muy claros NO gasificados. No mate, no café." },
          { dayOffset: -1, time: "21:10", text: "Preparar Barex: disolver 1 envase en 1 litro. Preparar el segundo envase de la misma manera." },
          { dayOffset: -1, time: "23:00", text: "Tomar 1 comprimido de Bigetric y comenzar el primer litro de Barex: un vaso grande (~250 cm³) cada 15 minutos hasta completar 1 litro." },
          { dayOffset:  0, time: "07:00", text: "Tomar 1 comprimido de Bigetric y tomar el segundo litro de Barex: un vaso grande cada 15 minutos hasta completarlo." },
          { dayOffset:  0, time: "10:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "15:31–20:00", from: "15:31", to: "20:00", steps: [
          { dayOffset: -1, time: "21:00", text: "Cena: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset:  0, time: "07:00", text: "Desayuno: té o café con azúcar o edulcorante, a gusto." },
          { dayOffset:  0, time: "08:00", text: "Tomar 4 comprimidos de Bisacodilo (incluidos en el Barex Kit) con un vaso de agua, sin masticarlos. Luego líquidos muy claros NO gasificados. No mate, no café." },
          { dayOffset:  0, time: "08:10", text: "Preparar Barex: disolver 1 envase en 1 litro. Preparar el segundo envase de la misma manera." },
          { dayOffset:  0, time: "09:00", text: "Tomar 1 comprimido de Bigetric y comenzar el primer litro de Barex: un vaso grande (~250 cm³) cada 15 minutos hasta completar 1 litro." },
          { dayOffset:  0, time: "11:00", text: "Tomar 1 comprimido de Bigetric y tomar el segundo litro de Barex: un vaso grande cada 15 minutos hasta completarlo." },
          { dayOffset:  0, time: "13:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]}
      ]
    },

    barexplus: {
      label: "Barex Plus",
      timeBands: [
        { label: "08:00–09:30", from: "08:00", to: "09:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "19:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "20:00", text: "Tomar 1 comprimido de Bigetric. Vaciar el sobre rotulado “DOSIS 1” en el vaso. Agregar agua potable hasta la línea (480 ml) y disolver. Beber todo en 30 minutos. Luego llenar el vaso solo con agua hasta la línea y tomarlo en los siguientes 30 minutos." },
          { dayOffset:  0, time: "04:00", text: "Tomar 1 comprimido de Bigetric. Vaciar los sobres “DOSIS 2A” y “DOSIS 2B” en el vaso. Agregar agua hasta 480 ml y disolver. Beber todo en 30 minutos. Luego llenar el vaso solo con agua hasta la línea y tomarlo en los siguientes 30 minutos." },
          { dayOffset:  0, time: "06:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "09:31–11:30", from: "09:31", to: "11:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "22:00", text: "Tomar 1 comprimido de Bigetric. Preparar “DOSIS 1” en vaso (480 ml). Beber todo en 30 minutos. Luego agua hasta la línea y tomar en los siguientes 30 minutos." },
          { dayOffset:  0, time: "06:00", text: "Tomar 1 comprimido de Bigetric. Preparar “DOSIS 2A” + “DOSIS 2B” en vaso (480 ml). Beber todo en 30 minutos. Luego agua hasta la línea y tomar en los siguientes 30 minutos." },
          { dayOffset:  0, time: "08:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "11:31–15:30", from: "11:31", to: "15:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "23:00", text: "Tomar 1 comprimido de Bigetric. Preparar “DOSIS 1” en vaso (480 ml). Beber todo en 30 minutos. Luego agua hasta la línea y tomar en los siguientes 30 minutos." },
          { dayOffset:  0, time: "07:00", text: "Tomar 1 comprimido de Bigetric. Preparar “DOSIS 2A” + “DOSIS 2B” en vaso (480 ml). Beber todo en 30 minutos. Luego agua hasta la línea y tomar en los siguientes 30 minutos." },
          { dayOffset:  0, time: "10:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "15:31–20:00", from: "15:31", to: "20:00", steps: [
          { dayOffset: -1, time: "21:00", text: "Cena: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset:  0, time: "07:00", text: "Desayuno: té o café con azúcar o edulcorante, a gusto." },
          { dayOffset:  0, time: "08:00", text: "Tomar 1 comprimido de Bigetric. Preparar “DOSIS 1” en vaso (480 ml). Beber todo en 30 minutos. Luego agua hasta la línea y tomar en los siguientes 30 minutos." },
          { dayOffset:  0, time: "11:00", text: "Tomar 1 comprimido de Bigetric. Preparar “DOSIS 2A” + “DOSIS 2B” en vaso (480 ml). Beber todo en 30 minutos. Luego agua hasta la línea y tomar en los siguientes 30 minutos." },
          { dayOffset:  0, time: "13:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]}
      ]
    },

    sulfodom: {
      label: "Sulfodom",
      timeBands: [
        { label: "08:00–09:30", from: "08:00", to: "09:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "19:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "20:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) con agua hasta la línea del vaso (480 ml). Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "04:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "06:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "09:31–11:30", from: "09:31", to: "11:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "22:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "06:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "08:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "11:31–15:30", from: "11:31", to: "15:30", steps: [
          { dayOffset: -1, time: "13:00", text: "Almuerzo: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset: -1, time: "20:00", text: "Cena: caldos colados desgrasados y gelatina o helados de agua (no rojo ni color intenso)." },
          { dayOffset: -1, time: "23:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "07:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "10:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]},
        { label: "15:31–20:00", from: "15:31", to: "20:00", steps: [
          { dayOffset: -1, time: "21:00", text: "Cena: carnes rojas o blancas con arroz o fideos. Postre: gelatina y/o helados de agua (no rojo ni color intenso; ananá o limón). Última comida sólida antes del examen." },
          { dayOffset:  0, time: "07:00", text: "Desayuno: té o café con azúcar o edulcorante, a gusto." },
          { dayOffset:  0, time: "08:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "11:00", text: "Tomar 1 comprimido de Bigetric. Diluir 1 frasco de SULFODOM (177 ml) hasta 480 ml. Tomar todo en 30–60 minutos. Luego tomar 1 litro de agua en 1 hora." },
          { dayOffset:  0, time: "13:00", text: "Ayuno total de sólidos y líquidos, incluido el agua, a partir de esta hora. No chicles ni caramelos." }
        ]}
      ]
    }
  };

  function buildPlanForRegimen(regimenKey, procedureDate, isConstipated) {
    const protocol = protocols[regimenKey];
    const bandPick = pickTimeBand(protocol, procedureDate);

    const commonSteps = buildCommonSteps(procedureDate, isConstipated);
    const bandSteps = bandPick.band.steps.map(s => ({
      datetime: setDateWithTime(procedureDate, s.dayOffset, s.time),
      text: s.text
    }));

    const arrival = new Date(procedureDate.getTime() - 15 * 60 * 1000);
    const arrivalStep = { datetime: arrival, text: "Presentarse para la realización del estudio." };

    return {
      steps: [...commonSteps, ...bandSteps, arrivalStep],
      selectedBandLabel: bandPick.band.label,
      approximated: bandPick.approximated
    };
  }

  function renderPlan(steps) {
    const container = document.getElementById("prep-steps");
    container.innerHTML = "";
    currentPlan = steps;

    steps.forEach(step => {
      const wrapper = document.createElement("div");
      wrapper.className = "prep-step";

      const timeEl = document.createElement("div");
      timeEl.className = "prep-time";
      timeEl.textContent = formatDateTime(step.datetime);

      const descEl = document.createElement("div");
      descEl.className = "prep-desc";

      if (step.linkText && step.linkHref) {
        if (step.textBefore) descEl.appendChild(document.createTextNode(step.textBefore));
        const a = document.createElement("a");
        a.href = step.linkHref;
        a.className = "inline-link";
        a.textContent = step.linkText;
        descEl.appendChild(a);
        if (step.textAfter) descEl.appendChild(document.createTextNode(step.textAfter));
      } else {
        descEl.textContent = step.text;
      }

      wrapper.appendChild(timeEl);
      wrapper.appendChild(descEl);
      container.appendChild(wrapper);
    });

    document.getElementById("plan-card").style.display = "block";
    const note = document.getElementById("general-note");
    if (note) note.style.display = "block";
  }

  (function () {
    const ua = navigator.userAgent || navigator.vendor || window.opera;
    const isIOS = /iPad|iPhone|iPod/.test(ua);
    const isChromeIOS = /CriOS/.test(ua);

    if (isIOS && isChromeIOS) {
      const banner = document.getElementById("ios-chrome-banner");
      if (banner) banner.style.display = "block";
    }
  })();

  function toICSDateTime(date) {
    const y = date.getFullYear();
    const m = pad2(date.getMonth() + 1);
    const d = pad2(date.getDate());
    const hh = pad2(date.getHours());
    const mm = pad2(date.getMinutes());
    const ss = pad2(date.getSeconds());
    return `${y}${m}${d}T${hh}${mm}${ss}`;
  }

  function escapeICS(text) {
    return text
      .replace(/\\/g, "\\\\")
      .replace(/,/g, "\\,")
      .replace(/;/g, "\\;")
      .replace(/\r?\n/g, "\\n");
  }

  function generateICS(steps) {
    let ics = "BEGIN:VCALENDAR\r\n" +
              "VERSION:2.0\r\n" +
              "PRODID:-//CheckColono//ES\r\n" +
              "CALSCALE:GREGORIAN\r\n";

    const now = new Date();
    const dtstamp = toICSDateTime(now);

    steps.forEach((step, index) => {
      const start = toICSDateTime(step.datetime);

      let summary = "";
      if (step.linkText) {
        summary = (step.textBefore || "") + step.linkText + (step.textAfter || "");
      } else {
        summary = step.text || "";
      }
      summary = escapeICS(summary);

      const uid = `checkcolono-${index}-${+step.datetime}@local`;

      ics += "BEGIN:VEVENT\r\n";
      ics += `UID:${uid}\r\n`;
      ics += `DTSTAMP:${dtstamp}\r\n`;
      ics += `DTSTART:${start}\r\n`;
      ics += `SUMMARY:${summary}\r\n`;
      ics += "END:VEVENT\r\n";
    });

    ics += "END:VCALENDAR\r\n";

    const blob = new Blob([ics], { type: "text/calendar;charset=utf-8" });
    const url = URL.createObjectURL(blob);
    const a = document.createElement("a");
    a.href = url;
    a.download = "checkcolono-plan.ics";
    document.body.appendChild(a);
    a.click();
    document.body.removeChild(a);
    URL.revokeObjectURL(url);
  }

  document.getElementById("btn-generar").addEventListener("click", () => {
    const regimen = document.getElementById("regimen").value;
    const fechaEstudio = document.getElementById("procedimiento").value;
    const constipado = document.getElementById("constipado").value;

    if (!regimen) {
      alert("Por favor, seleccioná tu esquema de preparación.");
      return;
    }
    if (!fechaEstudio) {
      alert("Por favor, ingresá la fecha y hora del estudio.");
      return;
    }
    if (!constipado) {
      alert("Por favor, indicá si sos constipado/a.");
      return;
    }

    const procedureDate = new Date(fechaEstudio);
    const isConstipated = (constipado === "si");

    const result = buildPlanForRegimen(regimen, procedureDate, isConstipated);

    showTimebandBannerIfNeeded(result.approximated, result.selectedBandLabel);
    renderPlan(result.steps);

    document.getElementById("plan-card").scrollIntoView({ behavior: "smooth" });
  });

  document.getElementById("export-ics").addEventListener("click", () => {
    if (!currentPlan || currentPlan.length === 0) {
      alert("Primero generá tu plan para poder exportarlo al calendario.");
      return;
    }
    generateICS(currentPlan);
  });
</script>
</body>
</html>

